- name: Install packages
  ansible.builtin.apt:
    name: git,make,golang,libvirt-dev,make,bash,gcc,git,ca-certificates,guestfs-tools,cloud-utils,genisoimage,openssh,livecd-tools,etcd,cephadm
    state: present
- name: Schedule Docker cleanup
  ansible.builtin.cron:
    name: "Docker cleanup"
    user: "root"
    minute: "0"
    hour: "5"
    job: "/usr/bin/docker system prune -f > /dev/null 2>&1"
- name: install govnocloud-master service
  ansible.builtin.template:
    src: govnocloud-master.service.j2
    dest: /etc/systemd/system/govnocloud-master.service
    mode: 0644
  register: govnocloud_master_service
- name: reload systemd
  ansible.builtin.systemd:
    daemon_reload: yes
  when: govnocloud_master_service.changed
- name: start etcd
  ansible.builtin.systemd:
    name: etcd
    state: started
    enabled: yes
- name: copy cleanup script
  ansible.builtin.copy:
    src: cleanup.sh
    dest: /usr/local/bin/cleanup.sh
    mode: 0755
- name: allow govnocloud-master through firewall
  ansible.posix.firewalld:
    port: 6969/tcp
    permanent: yes
    state: enabled
- name: add ceph user
  ansible.builtin.user:
    name: ceph
    state: present
    system: yes
- name: bootstrap ceph
  ansible.builtin.shell: |
    cephadm bootstrap --mon-ip {{ ansible_enp0s25.ipv4.address }}
  args:
    executable: /bin/bash
  become: true
  become_user: ceph
  become_method: sudo
  register: ceph_bootstrap