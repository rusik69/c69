---
- name: install wakeonlan
  ansible.builtin.apt:
    name: wakeonlan
    state: present

- name: copy wol.sh
  ansible.builtin.copy:
    src: wol.sh
    dest: /usr/local/bin/wol.sh
    mode: 0755

- name: Install dnsmasq
  ansible.builtin.apt:
    name: dnsmasq
    state: present

- name: Configure dnsmasq
  ansible.builtin.copy:
    dest: /etc/dnsmasq.d/pxe.conf
    content: |
      interface=eth0,lo
      bind-interfaces
      dhcp-range=eth0,10.0.0.10,10.0.0.200
      dhcp-boot=pxelinux.0
      enable-tftp
      tftp-root=/srv/tftp

- name: Restart dnsmasq
  ansible.builtin.systemd:
    name: dnsmasq
    state: restarted
  become: true

- name: ensure /srv/tftp exists
  ansible.builtin.file:
    path: /srv/tftp
    state: directory

- name: Download pxelinux.0
  ansible.builtin.get_url:
    url: http://archive.ubuntu.com/ubuntu/dists/focal/main/installer-amd64/current/legacy-images/netboot/pxelinux.0
    dest: /srv/tftp/pxelinux.0

- name: Download Ubuntu 20.04.1 Live Server ISO
  ansible.builtin.get_url:
    url: https://releases.ubuntu.com/22.04/ubuntu-22.04.4-live-server-amd64.iso
    dest: /srv/tftp/ubuntu-22.04.4-live-server-amd64.iso

- name: Mount Ubuntu 20.04.1 Live Server ISO
  ansible.builtin.mount:
    path: /mnt
    src: /srv/tftp/ubuntu-22.04.4-live-server-amd64.iso
    fstype: iso9660
    opts: loop
    state: mounted
  become: true

- name: Copy kernel and initrd
  ansible.builtin.copy:
    src: /mnt/casper/{{ item }}
    dest: /srv/tftp/{{ item }}
  loop:
    - vmlinuz
    - initrd
  become: true

- name: Install syslinux-common
  ansible.builtin.apt:
    name: syslinux-common
    state: present
  become: true

- name: Copy ldlinux.c32
  ansible.builtin.copy:
    src: /usr/lib/syslinux/modules/bios/ldlinux.c32
    dest: /srv/tftp/ldlinux.c32
  become: true

- name: ensure /srv/tftp/pxelinux.cfg exists
  ansible.builtin.file:
    path: /srv/tftp/pxelinux.cfg
    state: directory

- name: Create pxelinux.cfg/default
  ansible.builtin.copy:
    dest: /srv/tftp/pxelinux.cfg/default
    content: |
      DEFAULT install
      LABEL install
        KERNEL vmlinuz
        INITRD initrd
        APPEND root=/dev/ram0 ramdisk_size=1500000 ip=dhcp url=http://10.0.0.1/ubuntu-22.04.4-live-server-amd64.iso
  become: true

- name: Install Nginx
  ansible.builtin.apt:
    name: nginx
    state: present
  become: true

- name: Configure Nginx to serve /srv/tftp
  ansible.builtin.copy:
    dest: /etc/nginx/sites-available/tftp
    content: |
      server {
        listen 80;
        server_name _;
        location / {
          root /srv/tftp;
          autoindex on;
        }
      }
  become: true

- name: Enable Nginx configuration
  ansible.builtin.file:
    src: /etc/nginx/sites-available/tftp
    dest: /etc/nginx/sites-enabled/tftp
    state: link
  become: true

- name: Restart Nginx
  ansible.builtin.systemd:
    name: nginx
    state: restarted
  become: true