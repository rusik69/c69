---
- name: install wakeonlan
  ansible.builtin.apt:
    name: wakeonlan
    state: present

- name: copy wol.sh
  ansible.builtin.copy:
    src: wol.sh
    dest: /usr/local/bin/wol.sh
    mode: 0755

- name: Install dnsmasq
  ansible.builtin.apt:
    name: dnsmasq
    state: present
  become: true

- name: Configure dnsmasq
  ansible.builtin.copy:
    dest: /etc/dnsmasq.d/pxe.conf
    content: |
      interface=eth0,lo
      bind-interfaces
      dhcp-range=eth0,10.0.0.10,10.0.0.200
      dhcp-boot=pxelinux.0
      enable-tftp
      tftp-root=/srv/tftp
  become: true

- name: Restart dnsmasq
  ansible.builtin.systemd:
    name: dnsmasq
    state: restarted
  become: true

- name: Download pxelinux.0
  ansible.builtin.get_url:
    url: http://archive.ubuntu.com/ubuntu/dists/focal/main/installer-amd64/current/legacy-images/netboot/pxelinux.0
    dest: /srv/tftp/pxelinux.0

- name: Download Ubuntu 20.04.1 Live Server ISO
  ansible.builtin.get_url:
    url: http://releases.ubuntu.com/focal/ubuntu-20.04.1-live-server-amd64.iso
    dest: /srv/tftp/ubuntu-20.04.1-live-server-amd64.iso

- name: Mount Ubuntu 20.04.1 Live Server ISO
  ansible.builtin.mount:
    path: /mnt
    src: /srv/tftp/ubuntu-20.04.1-live-server-amd64.iso
    fstype: iso9660
    opts: loop
    state: mounted
  become: true

- name: Copy kernel and initrd
  ansible.builtin.copy:
    src: /mnt/casper/{{ item }}
    dest: /srv/tftp/{{ item }}
  loop:
    - vmlinuz
    - initrd
  become: true

- name: Install syslinux-common
  ansible.builtin.apt:
    name: syslinux-common
    state: present
  become: true

- name: Copy ldlinux.c32
  ansible.builtin.copy:
    src: /usr/lib/syslinux/modules/bios/ldlinux.c32
    dest: /srv/tftp/ldlinux.c32
  become: true

- name: Create pxelinux.cfg/default
  ansible.builtin.copy:
    dest: /srv/tftp/pxelinux.cfg/default
    content: |
      DEFAULT install
      LABEL install
        KERNEL vmlinuz
        INITRD initrd
        APPEND root=/dev/ram0 ramdisk_size=1500000 ip=dhcp url=http://releases.ubuntu.com/focal/ubuntu-20.04.1-live-server-amd64.iso
  become: true